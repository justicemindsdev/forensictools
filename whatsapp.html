q<!DOCTYPE html><html lang="en" class="dark"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justice Minds - Digital Evidence Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#1a508b',
                            dark: '#0d2d4e',
                            light: '#2c6bb1'
                        },
                        secondary: {
                            DEFAULT: '#646464',
                            dark: '#424242',
                            light: '#888888'
                        },
                        justice: {
                            dark: '#1c1c28',
                            DEFAULT: '#232336',
                            light: '#2d2d45',
                            accent: '#3f3f5f'
                        }
                    },
                },
            },
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .chat-message:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #1a508b;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #message-table {
            table-layout: fixed;
        }
        
        .badge {
            @apply px-2 py-0.5 text-xs font-medium rounded;
        }
        
        .badge-blue {
            @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300;
        }
        
        .badge-red {
            @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300;
        }
        
        .badge-green {
            @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300;
        }
        
        .badge-yellow {
            @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 12px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #1a508b;
            z-index: 1;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 22px;
            width: 2px;
            height: calc(100% - 12px);
            background-color: #1a508b;
            z-index: 0;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .evidence-container {
            position: relative;
            border-left: 3px solid #1a508b;
        }
        
        .evidence-container::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 10px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #1a508b;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1c1c28;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3f3f5f;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a6a;
        }
        
        .official-stamp {
            position: relative;
            display: inline-block;
            color: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            padding: 4px 8px;
            font-weight: 600;
            font-size: 0.7rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 5px rgba(255, 255, 255, 0.1);
            letter-spacing: 0.5px;
            background-color: rgba(30, 30, 45, 0.6);
        }
        
        .official-stamp::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 48%, rgba(255, 255, 255, 0.1) 50%, transparent 52%);
            background-size: 8px 8px;
        }

        .auth-text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive design enhancements */
        @media (max-width: 768px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            #message-table {
                font-size: 0.85rem;
            }
            
            #message-table th {
                white-space: nowrap;
                padding: 0.5rem 0.3rem;
                font-size: 0.7rem;
            }
            
            #message-table td {
                padding: 0.5rem 0.3rem;
            }
            
            .stats-container {
                margin-top: 1rem;
            }
            
            .evidence-container {
                padding-left: 0.75rem !important;
            }
            
            .official-stamp {
                font-size: 0.65rem;
                padding: 3px 6px;
            }
        }
        
        @media (max-width: 640px) {
            header .text-2xl {
                font-size: 1.25rem;
                line-height: 1.2;
            }
            
            header .text-xs {
                font-size: 0.65rem;
            }
            
            .nav-tab {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .nav-tab svg {
                width: 16px;
                height: 16px;
            }
            
            .text-xl {
                font-size: 1.1rem;
            }
            
            .py-6 {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            
            .p-6 {
                padding: 1rem;
            }
            
            .mb-6 {
                margin-bottom: 0.75rem;
            }
        }
        
        /* Enhanced government aesthetic */
        .gov-panel {
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 0, 255, 0.05);
        }
        
        .gov-highlight {
            animation: govHighlight 4s infinite alternate;
        }
        
        @keyframes govHighlight {
            0%, 90% { box-shadow: 0 0 5px rgba(26, 80, 139, 0.2); }
            100% { box-shadow: 0 0 8px rgba(26, 80, 139, 0.5); }
        }
        
        .header-border {
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-justice-dark text-gray-100 min-h-screen">
    <header class="bg-justice py-4 border-b border-justice-accent shadow-lg header-border">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="flex flex-col">
                    <h1 class="text-2xl font-bold auth-text-shadow text-white">JUSTICE MINDS FORENSICS INTELLIGENCE</h1>
                    <span class="text-xs text-gray-400">DIGITAL EVIDENCE MANAGEMENT SYSTEM</span>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-right">
                    <div class="text-sm font-medium">CASE: #JM-<span id="case-id">24051988</span></div>
                    <div class="text-xs text-gray-400" id="timestamp-display"></div>
                </div>
                <div class="official-stamp">AUTHENTICATED</div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <div class="bg-justice rounded-lg shadow-lg overflow-hidden mb-6">
            <div class="flex items-center border-b border-justice-accent">
                <button class="nav-tab py-3 px-6 font-medium flex items-center space-x-2 text-white bg-justice-accent" data-tab="chat">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <span>Chat Analysis</span>
                </button>
                <button class="nav-tab py-3 px-6 font-medium flex items-center space-x-2 text-gray-400 hover:text-white" data-tab="evidence">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Evidence Management</span>
                </button>
                <button class="nav-tab py-3 px-6 font-medium flex items-center space-x-2 text-gray-400 hover:text-white" data-tab="media">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>Media Gallery</span>
                </button>
                <button class="nav-tab py-3 px-6 font-medium flex items-center space-x-2 text-gray-400 hover:text-white" data-tab="ai">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <span>AI Analysis</span>
                </button>
            </div>
            
            <div class="tab-content" id="chat-tab">
                <div class="p-6">
                    <div class="mb-6">
                        <div class="bg-justice-light rounded-lg p-6 shadow-inner gov-panel">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                Upload Chat Evidence
                            </h2>
                            <div class="flex flex-col md:flex-row gap-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Select WhatsApp chat file or zip archive
                                    </label>
                                    <input type="file" id="file-input" class="block w-full text-base border border-justice-accent rounded-md focus:outline-none focus:ring-primary focus:border-primary cursor-pointer
                                        file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-primary file:text-white
                                        hover:file:bg-primary-dark bg-justice p-1.5" accept=".txt,.zip">
                                </div>
                                <div class="flex items-end">
                                    <button id="analyze-btn" class="bg-primary hover:bg-primary-dark text-white font-medium py-2 px-6 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed h-10 flex items-center" disabled="">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                        Process Evidence
                                    </button>
                                </div>
                            </div>

                            <div class="mt-4 border-t border-justice-accent pt-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Upload Media Files (Optional)
                                </label>
                                <p class="text-xs text-gray-400 mb-2">Upload media files to integrate with chat timeline using metadata</p>
                                <input type="file" id="timeline-media-input" class="block w-full text-base border border-justice-accent rounded-md focus:outline-none focus:ring-primary focus:border-primary cursor-pointer
                                    file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-primary file:text-white
                                    hover:file:bg-primary-dark bg-justice p-1.5" accept="image/*,video/*" multiple="">
                            </div>
                            
                            <div id="upload-info" class="mt-4 text-sm text-gray-400 hidden"></div>
                        </div>
                    </div>

                    <div id="loading" class="flex flex-col items-center justify-center py-10 hidden">
                        <div class="loading-spinner mb-4"></div>
                        <p id="loading-text" class="text-gray-400">Processing digital evidence...</p>
                    </div>

                    <div id="results-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 hidden">
                        <div class="lg:col-span-2">
                            <div class="bg-justice-light rounded-lg p-6 shadow-inner h-full gov-panel">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="flex items-center">
                                        <h2 class="text-xl font-semibold mr-4">Chat Message Transcript</h2>
                                        <button id="reset-filter" class="text-xs bg-justice-accent hover:bg-justice rounded px-2 py-1 hidden">
                                            Show All Messages
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex items-center gap-2 mr-2">
                                            <span class="text-sm text-gray-400">Show Media:</span>
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="show-media-inline" class="sr-only peer">
                                                <div class="relative w-10 h-5 bg-justice-accent rounded-full peer peer-checked:bg-primary-dark peer-focus:outline-none">
                                                    <div class="absolute w-4 h-4 bg-white rounded-full left-0.5 top-0.5 transition-all duration-300 transform peer-checked:translate-x-5"></div>
                                                </div>
                                            </label>
                                        </div>
                                        <input type="text" id="message-search" placeholder="Search messages..." class="px-3 py-1 border border-justice-accent bg-justice rounded-md text-base focus:outline-none focus:ring-1 focus:ring-primary">
                                        <select id="message-filter" class="px-3 py-1 border border-justice-accent bg-justice rounded-md text-base focus:outline-none focus:ring-1 focus:ring-primary">
                                            <option value="all">All Messages</option>
                                            <option value="questions">Questions</option>
                                            <option value="phrases">Common Phrases</option>
                                            <option value="media">Media Files</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table id="message-table" class="w-full text-left">
                                        <thead>
                                            <tr class="bg-justice-accent">
                                                <th class="py-2 px-3 w-32 text-sm font-medium">EVIDENCE ID</th>
                                                <th class="py-2 px-3 w-44 text-sm font-medium">TIMESTAMP</th>
                                                <th class="py-2 px-3 w-32 text-sm font-medium">SOURCE</th>
                                                <th class="py-2 px-3 text-sm font-medium">CONTENT</th>
                                                <th class="py-2 px-3 w-24 text-sm font-medium">ACTIONS</th>
                                            </tr>
                                        </thead>
                                        <tbody id="messages-container">
                                            <!-- Messages will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <div>
                                        <span id="message-count" class="text-sm text-gray-400">0 messages</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="prev-page" class="px-3 py-1 bg-justice-accent rounded-md text-sm disabled:opacity-50">Previous</button>
                                        <span id="page-info" class="text-sm text-gray-400 self-center">Page 1</span>
                                        <button id="next-page" class="px-3 py-1 bg-justice-accent rounded-md text-sm disabled:opacity-50">Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-container">
                            <div class="bg-justice-light rounded-lg p-6 shadow-inner mb-6 gov-panel">
                                <h2 class="text-xl font-semibold mb-4 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    Evidence Statistics
                                </h2>
                                <div id="stats-basic" class="grid grid-cols-2 gap-4 mb-6">
                                    <div class="bg-justice p-4 rounded-md shadow-sm">
                                        <p class="text-sm text-gray-400">Total Messages</p>
                                        <p id="total-messages" class="text-2xl font-semibold">0</p>
                                    </div>
                                    <div class="bg-justice p-4 rounded-md shadow-sm">
                                        <p class="text-sm text-gray-400">Total Words</p>
                                        <p id="total-words" class="text-2xl font-semibold">0</p>
                                    </div>
                                    <div class="bg-justice p-4 rounded-md shadow-sm">
                                        <p class="text-sm text-gray-400">Evidentiary Period</p>
                                        <p id="active-days" class="text-2xl font-semibold">0 days</p>
                                    </div>
                                    <div class="bg-justice p-4 rounded-md shadow-sm">
                                        <p class="text-sm text-gray-400">Media Exhibits</p>
                                        <p id="media-count" class="text-2xl font-semibold">0</p>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-medium text-lg mb-2 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                        Subjects
                                    </h3>
                                    <div id="participants-list" class="text-sm space-y-2">
                                        <!-- Participants will be inserted here -->
                                    </div>
                                    <script>
                                        // Make participants list items clickable for subject filtering
                                        document.addEventListener('DOMContentLoaded', function() {
                                            // Add click handler after participants are loaded
                                            const observer = new MutationObserver(function(mutations) {
                                                mutations.forEach(function(mutation) {
                                                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                                                        addParticipantClickHandlers();
                                                    }
                                                });
                                            });
                                            
                                            observer.observe(document.getElementById('participants-list'), { 
                                                childList: true 
                                            });
                                            
                                            function addParticipantClickHandlers() {
                                                document.querySelectorAll('#participants-list > div').forEach(div => {
                                                    div.style.cursor = 'pointer';
                                                    div.title = 'Click to filter messages from this subject';
                                                    div.classList.add('hover:bg-justice-accent');
                                                    
                                                    // Get subject name from the div
                                                    const name = div.querySelector('.font-medium').textContent;
                                                    
                                                    // Add click handler if it doesn't already have one
                                                    if (!div.hasAttribute('data-has-click-handler')) {
                                                        div.setAttribute('data-has-click-handler', 'true');
                                                        div.addEventListener('click', function() {
                                                            filterBySubject(name);
                                                        });
                                                    }
                                                });
                                            }
                                        });
                                    </script>
                                </div>
                            </div>

                            <div class="bg-justice-light rounded-lg p-6 shadow-inner mb-6 gov-panel">
                                <h2 class="text-xl font-semibold mb-4 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                    </svg>
                                    Linguistic Analysis
                                </h2>
                                <p class="text-sm text-gray-400 mb-4">Most frequently used terms (excluding common words)</p>
                                <div class="h-64">
                                    <canvas id="word-freq-chart"></canvas>
                                </div>
                            </div>

                            <div class="bg-justice-light rounded-lg p-6 shadow-inner gov-panel">
                                <h2 class="text-xl font-semibold mb-4 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path>
                                    </svg>
                                    Pattern Recognition
                                </h2>
                                <div class="space-y-3">
                                    <div>
                                        <h3 class="font-medium mb-1">Affirmative Statements</h3>
                                        <p id="love-count" class="text-sm text-gray-400">0 instances found</p>
                                    </div>
                                    <div>
                                        <h3 class="font-medium mb-1">Interrogative Statements</h3>
                                        <p id="question-count" class="text-sm text-gray-400">0 questions found</p>
                                    </div>
                                    <div>
                                        <h3 class="font-medium mb-1">Response Rate Analysis</h3>
                                        <p id="response-rate" class="text-sm text-gray-400">0% of questions received responses</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content hidden" id="evidence-tab">
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-justice-light rounded-lg p-6 shadow-inner gov-panel">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                Claims
                            </h2>
                            <div class="space-y-4">
                                <div class="bg-justice p-4 rounded-md">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Claim #1</h3>
                                        <span class="badge badge-blue">Active</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">The subject expressed intention to meet at location "Porchester Square" on multiple occasions.</p>
                                    <div class="mt-3 flex justify-between text-xs text-gray-400">
                                        <span>REFERENCE: JM-E2201, JM-E2205</span>
                                        <button class="text-primary hover:text-primary-light" onclick="highlightEvidence(['JM-E2201', 'JM-E2205'])">Show Evidence</button>
                                    </div>
                                </div>
                                
                                <div class="bg-justice p-4 rounded-md">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Claim #2</h3>
                                        <span class="badge badge-green">Verified</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">Communication was end-to-end encrypted as stated in the header of the chat logs.</p>
                                    <div class="mt-3 flex justify-between text-xs text-gray-400">
                                        <span>REFERENCE: JM-E2200</span>
                                        <button class="text-primary hover:text-primary-light" onclick="highlightEvidence(['JM-E2200'])">Show Evidence</button>
                                    </div>
                                </div>
                                
                                <div class="bg-justice p-4 rounded-md">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Claim #3</h3>
                                        <span class="badge badge-yellow">Under Review</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">Subject "James" requested unauthorized access to a secured location.</p>
                                    <div class="mt-3 flex justify-between text-xs text-gray-400">
                                        <span>REFERENCE: JM-E2208</span>
                                        <button class="text-primary hover:text-primary-light" onclick="highlightEvidence(['JM-E2208'])">Show Evidence</button>
                                    </div>
                                </div>
                                
                                <button id="add-claim-btn" class="w-full py-2 mt-2 bg-justice-accent hover:bg-justice rounded-md text-sm text-gray-300 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Add New Claim
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-justice-light rounded-lg p-6 shadow-inner gov-panel">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                Evidence
                            </h2>
                            <div id="evidence-list" class="space-y-4">
                                <div class="evidence-container bg-justice p-4 pl-6 rounded-md" id="evidence-JM-E2200">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Evidence ID: JM-E2200</h3>
                                        <span class="badge badge-green">Header</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">Messages and calls are end-to-end encrypted. No one outside of this chat, not even WhatsApp, can read or listen to them.</p>
                                    <div class="mt-3 text-xs text-gray-400">
                                        <span>TIMESTAMP: 2018-11-19 10:03:06</span>
                                    </div>
                                </div>
                                
                                <div class="evidence-container bg-justice p-4 pl-6 rounded-md" id="evidence-JM-E2201">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Evidence ID: JM-E2201</h3>
                                        <span class="badge badge-blue">Message</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">1 Porchester Square: Messages and calls are end-to-end encrypted. No one outside of this chat, not even WhatsApp, can read or listen to them.</p>
                                    <div class="mt-3 text-xs text-gray-400">
                                        <span>TIMESTAMP: 2018-11-19 10:03:06</span>
                                    </div>
                                </div>
                                
                                <div class="evidence-container bg-justice p-4 pl-6 rounded-md" id="evidence-JM-E2202">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Evidence ID: JM-E2202</h3>
                                        <span class="badge badge-blue">Message</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">+44 7594 736872: +44 7594 736872 created this group</p>
                                    <div class="mt-3 text-xs text-gray-400">
                                        <span>TIMESTAMP: 2018-11-19 10:03:06</span>
                                    </div>
                                </div>
                                
                                <div class="evidence-container bg-justice p-4 pl-6 rounded-md" id="evidence-JM-E2205">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Evidence ID: JM-E2205</h3>
                                        <span class="badge badge-blue">Message</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">1 Porchester Square: Rania C added you</p>
                                    <div class="mt-3 text-xs text-gray-400">
                                        <span>TIMESTAMP: 2020-10-19 18:16:36</span>
                                    </div>
                                </div>
                                
                                <div class="evidence-container bg-justice p-4 pl-6 rounded-md" id="evidence-JM-E2206">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Evidence ID: JM-E2206</h3>
                                        <span class="badge badge-blue">Message</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">Rania C: Welcome to the group Ben üéâ</p>
                                    <div class="mt-3 text-xs text-gray-400">
                                        <span>TIMESTAMP: 2020-10-19 18:16:49</span>
                                    </div>
                                </div>
                                
                                <div class="evidence-container bg-justice p-4 pl-6 rounded-md" id="evidence-JM-E2207">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Evidence ID: JM-E2207</h3>
                                        <span class="badge badge-blue">Message</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">Ben Mak ix: Thanks!A day of celebration üçª</p>
                                    <div class="mt-3 text-xs text-gray-400">
                                        <span>TIMESTAMP: 2020-10-19 18:18:27</span>
                                    </div>
                                </div>
                                
                                <div class="evidence-container bg-justice p-4 pl-6 rounded-md" id="evidence-JM-E2208">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-medium">Evidence ID: JM-E2208</h3>
                                        <span class="badge badge-yellow">Message</span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-300">Ben Mak ix: Hi! James has locked himself out do we have a key spare to get him in? üîë</p>
                                    <div class="mt-3 text-xs text-gray-400">
                                        <span>TIMESTAMP: 2020-10-19 19:14:57</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 bg-justice-light rounded-lg p-6 shadow-inner gov-panel">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Query Evidence
                        </h2>
                        <div class="relative">
                            <input type="text" id="evidence-query" placeholder="Ask a question about the evidence..." class="w-full px-4 py-3 bg-justice border border-justice-accent rounded-md text-base focus:outline-none focus:ring-1 focus:ring-primary">
                            <button id="query-btn" class="absolute right-2 top-2 bg-primary hover:bg-primary-dark text-white rounded-md px-4 py-1 font-medium">
                                Ask AI
                            </button>
                        </div>
                        <div id="query-result" class="mt-4 p-4 bg-justice rounded-md min-h-24 hidden">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400 mb-1">JUSTICE MINDS AI ANALYSIS</div>
                                    <div id="ai-response" class="text-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content hidden" id="media-tab">
                <div class="p-6">
                    <div class="bg-justice-light rounded-lg p-6 shadow-inner mb-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Upload Media Evidence
                        </h2>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Select media files related to investigation
                                </label>
                                <input type="file" id="media-input" class="block w-full text-base border border-justice-accent rounded-md focus:outline-none focus:ring-primary focus:border-primary cursor-pointer
                                    file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-primary file:text-white
                                    hover:file:bg-primary-dark bg-justice p-1.5" accept="image/*,video/*" multiple="">
                            </div>
                            <div class="flex items-end">
                                <button id="upload-media-btn" class="bg-primary hover:bg-primary-dark text-white font-medium py-2 px-6 rounded-md transition-colors h-10 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Upload Files
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="media-gallery">
                        <div class="bg-justice p-4 rounded-lg shadow-md">
                            <div class="relative pb-[75%] bg-black rounded-md overflow-hidden mb-2">
                                <img src="https://picsum.photos/400/300" alt="Sample evidence" class="absolute inset-0 w-full h-full object-cover">
                                <div class="absolute top-2 right-2 bg-justice-dark bg-opacity-75 px-2 py-1 rounded text-xs font-medium">
                                    PHOTO
                                </div>
                            </div>
                            <div>
                                <h3 class="font-medium text-sm mb-1">EXHIBIT JM-M001</h3>
                                <p class="text-xs text-gray-400">Extracted from device ‚Ä¢ 2023-08-17 23:20:55</p>
                                <div class="flex justify-between mt-2">
                                    <button class="text-xs text-primary hover:text-primary-light">View Details</button>
                                    <button class="text-xs text-primary hover:text-primary-light">Add to Evidence</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-justice p-4 rounded-lg shadow-md">
                            <div class="relative pb-[75%] bg-black rounded-md overflow-hidden mb-2">
                                <video class="absolute inset-0 w-full h-full object-cover" controls="">
                                    <source src="" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <div class="absolute top-2 right-2 bg-justice-dark bg-opacity-75 px-2 py-1 rounded text-xs font-medium">
                                    VIDEO
                                </div>
                            </div>
                            <div>
                                <h3 class="font-medium text-sm mb-1">EXHIBIT JM-M002</h3>
                                <p class="text-xs text-gray-400">Extracted from device ‚Ä¢ 2023-12-07 12:38:05</p>
                                <div class="flex justify-between mt-2">
                                    <button class="text-xs text-primary hover:text-primary-light">View Details</button>
                                    <button class="text-xs text-primary hover:text-primary-light">Add to Evidence</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content hidden" id="ai-tab">
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-justice-light rounded-lg p-6 shadow-inner gov-panel">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                Justice Minds Analysis
                            </h2>
                            <div class="space-y-4">
                                <div class="bg-justice p-4 rounded-md">
                                    <h3 class="font-medium mb-2">Selected Messages for Analysis</h3>
                                    <div id="selected-messages-container" class="text-sm text-gray-300 max-h-40 overflow-y-auto p-2 bg-justice-dark rounded-md">
                                        <p class="text-gray-500 italic">No messages selected. Select messages from the Chat Analysis tab.</p>
                                    </div>
                                </div>
                                
                                <div class="bg-justice p-4 rounded-md">
                                    <h3 class="font-medium mb-2">Analysis Options</h3>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="option-sentiment" class="mr-2 h-4 w-4 rounded">
                                            <label for="option-sentiment" class="text-sm">Sentiment Analysis</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="option-entities" class="mr-2 h-4 w-4 rounded">
                                            <label for="option-entities" class="text-sm">Entity Recognition</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="option-intent" class="mr-2 h-4 w-4 rounded" checked="">
                                            <label for="option-intent" class="text-sm">Intent Detection</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="option-timeline" class="mr-2 h-4 w-4 rounded" checked="">
                                            <label for="option-timeline" class="text-sm">Timeline Reconstruction</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-justice p-4 rounded-md">
                                    <h3 class="font-medium mb-2">AI Model Selection</h3>
                                    <select id="ai-model-select" class="w-full px-3 py-2 bg-justice-dark border border-justice-accent rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                                        <option value="anthropic/claude-3.7-sonnet:beta">JUSTICE MINDS v3.7 (Enhanced)</option>
                                        <option value="anthropic/claude-3.7-sonnet:thinking">JUSTICE MINDS v3.7 (Reasoning)</option>
                                        <option value="openai/o3-mini">JUSTICE MINDS Lite v3 (Standard)</option>
                                        <option value="deepseek/deepseek-r1-zero:free">DeepSeek R1 (Academic)</option>
                                    </select>
                                </div>
                                
                                <button id="run-analysis-btn" class="w-full py-3 bg-primary hover:bg-primary-dark text-white font-medium rounded-md transition-colors flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Run Analysis
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-justice-light rounded-lg p-6 shadow-inner">
                            <h2 class="text-xl font-semibold mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Analysis Results
                            </h2>
                            <div id="analysis-loading" class="hidden flex-col items-center justify-center py-10">
                                <div class="loading-spinner mb-4"></div>
                                <p id="analysis-loading-text" class="text-gray-400">Processing through Justice Minds AI...</p>
                            </div>
                            <div id="analysis-results" class="space-y-4">
                                <p class="text-gray-500 italic">Run analysis to see results</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize current timestamp
        function updateTimestamp() {
            const now = new Date();
            const formatted = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            document.getElementById('timestamp-display').textContent = formatted;
        }
        
        // Update timestamp initially and every second
        updateTimestamp();
        setInterval(updateTimestamp, 1000);
        
        // Generate random case ID
        document.getElementById('case-id').textContent = Math.floor(10000000 + Math.random() * 90000000).toString();
        
        // Global variables
        let chatMessages = [];
        let participants = new Map();
        let wordFrequency = {};
        let currentPage = 1;
        const messagesPerPage = 50;
        let filteredMessages = [];
        let wordChart = null;
        let selectedMessages = new Set();
        
        // Stopwords for filtering common words
        const stopwords = new Set([
            "a", "about", "above", "after", "again", "against", "all", "am", "an", "and", "any", "are", "aren't", "as", "at", 
            "be", "because", "been", "before", "being", "below", "between", "both", "but", "by", "can't", "cannot", "could", 
            "couldn't", "did", "didn't", "do", "does", "doesn't", "doing", "don't", "down", "during", "each", "few", "for", 
            "from", "further", "had", "hadn't", "has", "hasn't", "have", "haven't", "having", "he", "he'd", "he'll", "he's", 
            "her", "here", "here's", "hers", "herself", "him", "himself", "his", "how", "how's", "i", "i'd", "i'll", "i'm", 
            "i've", "if", "in", "into", "is", "isn't", "it", "it's", "its", "itself", "let's", "me", "more", "most", "mustn't", 
            "my", "myself", "no", "nor", "not", "of", "off", "on", "once", "only", "or", "other", "ought", "our", "ours", 
            "ourselves", "out", "over", "own", "same", "shan't", "she", "she'd", "she'll", "she's", "should", "shouldn't", 
            "so", "some", "such", "than", "that", "that's", "the", "their", "theirs", "them", "themselves", "then", "there", 
            "there's", "these", "they", "they'd", "they'll", "they're", "they've", "this", "those", "through", "to", "too", 
            "under", "until", "up", "very", "was", "wasn't", "we", "we'd", "we'll", "we're", "we've", "were", "weren't", 
            "what", "what's", "when", "when's", "where", "where's", "which", "while", "who", "who's", "whom", "why", "why's", 
            "with", "won't", "would", "wouldn't", "you", "you'd", "you'll", "you're", "you've", "your", "yours", "yourself", 
            "yourselves", "just", "like", "get", "got", "also", "much", "many", "even", "now", "one", "two", "will", "shall"
        ]);

        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const loadingEl = document.getElementById('loading');
        const loadingTextEl = document.getElementById('loading-text');
        const resultsContainer = document.getElementById('results-container');
        const messagesContainer = document.getElementById('messages-container');
        const messageSearch = document.getElementById('message-search');
        const messageFilter = document.getElementById('message-filter');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfoEl = document.getElementById('page-info');
        const messageCountEl = document.getElementById('message-count');
        const totalMessagesEl = document.getElementById('total-messages');
        const totalWordsEl = document.getElementById('total-words');
        const activeDaysEl = document.getElementById('active-days');
        const mediaCountEl = document.getElementById('media-count');
        const participantsListEl = document.getElementById('participants-list');
        const loveCountEl = document.getElementById('love-count');
        const questionCountEl = document.getElementById('question-count');
        const responseRateEl = document.getElementById('response-rate');
        const uploadInfoEl = document.getElementById('upload-info');
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const selectedMessagesContainer = document.getElementById('selected-messages-container');
        const evidenceQuery = document.getElementById('evidence-query');
        const queryBtn = document.getElementById('query-btn');
        const queryResult = document.getElementById('query-result');
        const aiResponse = document.getElementById('ai-response');
        const runAnalysisBtn = document.getElementById('run-analysis-btn');
        const analysisLoading = document.getElementById('analysis-loading');
        const analysisResults = document.getElementById('analysis-results');
        const addClaimBtn = document.getElementById('add-claim-btn');
        const mediaInput = document.getElementById('media-input');
        const uploadMediaBtn = document.getElementById('upload-media-btn');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Tab navigation
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    navTabs.forEach(t => {
                        t.classList.remove('bg-justice-accent');
                        t.classList.add('text-gray-400');
                        t.classList.remove('text-white');
                    });
                    
                    // Add active class to clicked tab
                    tab.classList.add('bg-justice-accent');
                    tab.classList.remove('text-gray-400');
                    tab.classList.add('text-white');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show the selected tab content
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                });
            });
            
            fileInput.addEventListener('change', handleFileInputChange);
            analyzeBtn.addEventListener('click', processChatData);
            messageSearch.addEventListener('input', filterAndDisplayMessages);
            messageFilter.addEventListener('change', filterAndDisplayMessages);
            
            // Add reset button event listener
            document.getElementById('reset-filter').addEventListener('click', resetAllFilters);
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayMessages();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < Math.ceil(filteredMessages.length / messagesPerPage)) {
                    currentPage++;
                    displayMessages();
                }
            });
            
            queryBtn.addEventListener('click', queryEvidence);
            runAnalysisBtn.addEventListener('click', runAnalysis);
            addClaimBtn.addEventListener('click', addNewClaim);
            uploadMediaBtn.addEventListener('click', uploadMedia);
        });

        // Handle file input change
        function handleFileInputChange() {
            const file = fileInput.files[0];
            if (!file) {
                analyzeBtn.disabled = true;
                return;
            }
            
            analyzeBtn.disabled = false;
            
            const fileInfo = `SELECTED: ${file.name} (${formatFileSize(file.size)})`;
            uploadInfoEl.textContent = fileInfo;
            uploadInfoEl.classList.remove('hidden');
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Process chat data
        async function processChatData() {
            const file = fileInput.files[0];
            if (!file) return;

            // Reset data
            chatMessages = [];
            participants = new Map();
            wordFrequency = {};
            currentPage = 1;
            selectedMessages.clear();
            
            // Show loading
            loadingEl.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            
            try {
                let chatText = '';
                
                // Process file based on type
                if (file.name.endsWith('.zip')) {
                    loadingTextEl.textContent = 'EXTRACTING ARCHIVE...';
                    const zip = new JSZip();
                    const zipContents = await zip.loadAsync(file);
                    
                    // Find the _chat.txt file in the zip
                    let chatFile = null;
                    zipContents.forEach((relativePath, zipEntry) => {
                        if (relativePath.endsWith('_chat.txt')) {
                            chatFile = zipEntry;
                        }
                    });
                    
                    if (chatFile) {
                        loadingTextEl.textContent = 'READING EVIDENCE FILE...';
                        chatText = await chatFile.async('text');
                    } else {
                        throw new Error('No _chat.txt file found in the archive');
                    }
                } else if (file.name.endsWith('.txt')) {
                    loadingTextEl.textContent = 'READING EVIDENCE FILE...';
                    chatText = await file.text();
                } else {
                    throw new Error('Unsupported file format. Please upload a .txt or .zip file.');
                }
                
                loadingTextEl.textContent = 'PARSING DIGITAL EVIDENCE...';
                await parseChatData(chatText);
                
                loadingTextEl.textContent = 'ANALYZING CONVERSATION PATTERNS...';
                await analyzeChat();
                
                // Display results
                displayMessages();
                displayStats();
                
                // Hide loading and show results
                loadingEl.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
                
            } catch (error) {
                loadingEl.classList.add('hidden');
                alert('Error processing evidence: ' + error.message);
                console.error(error);
            }
        }

        // Parse WhatsApp chat data
        async function parseChatData(chatText) {
            // Define a regex pattern to match WhatsApp messages
            // Format: [date, time] sender: message
            const messageRegex = /\[(\d{1,2}\/\d{1,2}\/\d{4}),\s(\d{1,2}:\d{2}(?::\d{2})?(?:\s[AP]M)?)\]\s([^:]+):\s([\s\S]*?)(?=\[\d{1,2}\/\d{1,2}\/\d{4}|$)/g;
            
            let match;
            let id = 0;
            
            while ((match = messageRegex.exec(chatText)) !== null) {
                const [, date, time, sender, message] = match;
                
                // Normalize sender name
                const normalizedSender = sender.trim();
                
                // Track participants
                if (!participants.has(normalizedSender)) {
                    participants.set(normalizedSender, {
                        name: normalizedSender,
                        messageCount: 0,
                        wordCount: 0
                    });
                }
                
                const participant = participants.get(normalizedSender);
                participant.messageCount++;
                
                // Count words in the message
                const words = message.split(/\s+/).filter(word => word.length > 0);
                participant.wordCount += words.length;
                
                // Determine if the message contains media
                const isMedia = message.includes('<Media omitted>') || 
                                message.includes('<image omitted>') || 
                                message.includes('<video omitted>') || 
                                message.includes('<audio omitted>');
                
                // Parse date in DD/MM/YYYY format
                const dateParts = date.split('/');
                const dateObj = new Date(
                    parseInt(dateParts[2]), // Year
                    parseInt(dateParts[1]) - 1, // Month (0-based)
                    parseInt(dateParts[0]) // Day
                );
                
                // Add time
                const timeParts = time.split(':');
                let hours = parseInt(timeParts[0]);
                const minutes = parseInt(timeParts[1]);
                const seconds = timeParts.length > 2 ? parseInt(timeParts[2]) : 0;
                
                // Handle AM/PM format if present
                if (time.includes('PM') && hours < 12) {
                    hours += 12;
                } else if (time.includes('AM') && hours === 12) {
                    hours = 0;
                }
                
                dateObj.setHours(hours, minutes, seconds);
                
                // Format the timestamp in YYYY-MM-DD HH:MM:SS format
                const formattedTimestamp = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2, '0')}-${dateObj.getDate().toString().padStart(2, '0')} ${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}:${dateObj.getSeconds().toString().padStart(2, '0')}`;
                
                // Add message to the array
                chatMessages.push({
                    id: `JM-E${(2200 + id++).toString().padStart(4, '0')}`,
                    sender: normalizedSender,
                    message: message.trim(),
                    timestamp: dateObj,
                    formattedTimestamp,
                    isMedia,
                    isQuestion: isQuestionMessage(message)
                });
            }
            
            // Sort messages by timestamp
            chatMessages.sort((a, b) => a.timestamp - b.timestamp);
            
            // Set filtered messages to all messages initially
            filteredMessages = [...chatMessages];
        }

        // Analyze chat data
        async function analyzeChat() {
            // Analyze word frequency
            const words = chatMessages
                .map(msg => msg.message.toLowerCase())
                .join(' ')
                .split(/\s+/)
                .filter(word => 
                    word.length > 2 && 
                    !stopwords.has(word.toLowerCase()) &&
                    !/^\d+$/.test(word) && // Exclude numbers
                    !/^[^\w\s]$/.test(word) // Exclude single punctuation
                );
            
            // Count word frequency
            words.forEach(word => {
                // Remove punctuation from the word
                const cleanWord = word.replace(/[^\w\s]/g, '');
                if (cleanWord.length > 2) {
                    wordFrequency[cleanWord] = (wordFrequency[cleanWord] || 0) + 1;
                }
            });
            
            // Find love expressions
            const loveExpressions = chatMessages.filter(msg => 
                msg.message.toLowerCase().includes('i love you') ||
                msg.message.toLowerCase().includes('love you') ||
                msg.message.toLowerCase().includes('love u') ||
                msg.message.toLowerCase().includes('‚ù§Ô∏è') ||
                msg.message.toLowerCase().includes('<3')
            );
            
            // Find questions and responses
            const questions = chatMessages.filter(msg => msg.isQuestion);
            
            // Analyze response rate
            let responsesCount = 0;
            
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                // Check if there's a message from another person within 3 messages after the question
                for (let j = chatMessages.indexOf(question) + 1; 
                     j < chatMessages.indexOf(question) + 4 && j < chatMessages.length; 
                     j++) {
                    if (chatMessages[j].sender !== question.sender) {
                        responsesCount++;
                        break;
                    }
                }
            }
            
            // Update global data
            loveExpressionsCount = loveExpressions.length;
            questionsCount = questions.length;
            questionResponseRate = questions.length > 0 ? (responsesCount / questions.length) * 100 : 0;
        }

        // Display messages
        function displayMessages() {
            // Calculate page info
            const totalPages = Math.max(1, Math.ceil(filteredMessages.length / messagesPerPage));
            currentPage = Math.min(currentPage, totalPages);
            
            // Calculate range for current page
            const startIndex = (currentPage - 1) * messagesPerPage;
            const endIndex = Math.min(startIndex + messagesPerPage, filteredMessages.length);
            
            // Update pagination UI
            pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            
            // Update message count
            messageCountEl.textContent = `${filteredMessages.length} messages`;
            
            // Clear current messages
            messagesContainer.innerHTML = '';
            
            // Get show media toggle state
            const showMediaInline = document.getElementById('show-media-inline').checked;
            
            // Generate message rows
            const messagesFragment = document.createDocumentFragment();
            
            for (let i = startIndex; i < endIndex; i++) {
                const msg = filteredMessages[i];
                const row = document.createElement('tr');
                row.className = 'chat-message border-t border-justice-accent';
                
                // Add selected class if the message is selected
                if (selectedMessages.has(msg.id)) {
                    row.classList.add('bg-primary', 'bg-opacity-20');
                }
                
                // Add question class if it's a question
                if (msg.isQuestion) {
                    row.classList.add('bg-blue-900', 'bg-opacity-20');
                }
                
                // Check if this message has an associated media file
                const mediaFile = findMediaFileForMessage(msg);
                
                // Create table cells
                let contentCell = '';
                
                if (msg.isMedia && showMediaInline) {
                    // If it's a media message and we have an associated media file uploaded
                    if (mediaFile) {
                        if (mediaFile.type.startsWith('image/')) {
                            contentCell = `
                                <div class="flex items-start">
                                    <span class="badge badge-blue mr-2 mt-1">MEDIA</span>
                                    <div>
                                        <div class="mb-2">${formatMessage(msg.message)}</div>
                                        <div class="relative w-56 h-40 bg-black rounded-md overflow-hidden">
                                            <img src="${mediaFile.url}" alt="Media content" class="absolute inset-0 w-full h-full object-cover">
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (mediaFile.type.startsWith('video/')) {
                            contentCell = `
                                <div class="flex items-start">
                                    <span class="badge badge-blue mr-2 mt-1">MEDIA</span>
                                    <div>
                                        <div class="mb-2">${formatMessage(msg.message)}</div>
                                        <div class="relative w-56 h-40 bg-black rounded-md overflow-hidden">
                                            <video class="absolute inset-0 w-full h-full object-cover" controls>
                                                <source src="${mediaFile.url}" type="${mediaFile.type}">
                                                Your browser does not support the video tag.
                                            </video>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        // Media message but no file uploaded
                        contentCell = `
                            <div class="flex items-start">
                                <span class="badge badge-blue mr-2 mt-1">MEDIA</span>
                                ${formatMessage(msg.message)}
                            </div>
                        `;
                    }
                } else {
                    // Regular message or media message with toggle off
                    contentCell = `
                        ${msg.isMedia ? '<span class="badge badge-blue">MEDIA</span> ' : ''}
                        ${msg.isQuestion ? '<span class="badge badge-yellow">QUESTION</span> ' : ''}
                        ${formatMessage(msg.message)}
                    `;
                }
                
                row.innerHTML = `
                    <td class="py-2 px-3 text-sm font-mono whitespace-nowrap text-gray-400">
                        ${msg.id}
                    </td>
                    <td class="py-2 px-3 text-sm font-mono whitespace-nowrap text-gray-400">
                        ${msg.formattedTimestamp}
                    </td>
                    <td class="py-2 px-3 text-sm font-medium whitespace-nowrap" 
                        onclick="filterBySubject('${msg.sender}')" style="cursor: pointer" 
                        title="Click to filter messages from this subject">
                        <div class="hover:text-primary transition-colors">${msg.sender}</div>
                    </td>
                    <td class="py-2 px-3 break-words">
                        ${contentCell}
                    </td>
                    <td class="py-2 px-3 whitespace-nowrap">
                        <button class="text-xs text-primary hover:text-primary-light select-msg-btn" data-id="${msg.id}">
                            ${selectedMessages.has(msg.id) ? 'Deselect' : 'Select'}
                        </button>
                    </td>
                `;
                
                messagesFragment.appendChild(row);
            }
            
            messagesContainer.appendChild(messagesFragment);
            
            // Add event listeners to select message buttons
            document.querySelectorAll('.select-msg-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const msgId = e.target.getAttribute('data-id');
                    toggleMessageSelection(msgId);
                });
            });
        }
        
        // Filter by subject when clicking on a sender's name
        function filterBySubject(subject) {
            // Don't change the UI dropdown state, just apply the filter directly
            // This keeps the interface cleaner and more focused
            
            // Filter messages directly
            filteredMessages = chatMessages.filter(msg => msg.sender === subject);
            
            // Reset to first page and refresh display
            currentPage = 1;
            displayMessages();
            
            // Update message count and indicate which subject is filtered
            messageCountEl.textContent = `${filteredMessages.length} messages from ${subject}`;
            
            // Highlight the selected subject in the subjects list (right panel)
            highlightSelectedSubject(subject);
        }
        
        // Highlight the selected subject in the sidebar
        function highlightSelectedSubject(subject) {
            // Remove highlight from all subjects
            document.querySelectorAll('#participants-list > div').forEach(div => {
                div.classList.remove('bg-primary', 'bg-opacity-20');
            });
            
            // Find the matching subject item and highlight it
            const subjectItems = document.querySelectorAll('#participants-list > div');
            subjectItems.forEach(item => {
                const name = item.querySelector('.font-medium').textContent;
                if (name === subject) {
                    item.classList.add('bg-primary', 'bg-opacity-20');
                }
            });
        }
        
        // Find uploaded media file associated with a message 
        function findMediaFileForMessage(message) {
            // This is where we would match uploaded media with the message based on metadata
            // For the demo, we'll use a simplified approach based on the message ID
            
            // In a real implementation, this would use EXIF data from the media files
            // to match timestamps with message timestamps
            
            // Get all uploaded media files
            const mediaItems = document.querySelectorAll('#media-gallery > div');
            
            // For demo purposes, we'll just return the first media item if it's a media message
            if (message.isMedia && mediaItems.length > 0) {
                const mediaId = mediaItems[0].querySelector('h3').textContent.split(' ')[1];
                const mediaElement = mediaItems[0].querySelector('img, video');
                
                if (mediaElement) {
                    const isVideo = mediaElement.tagName.toLowerCase() === 'video';
                    const url = isVideo ? 
                        mediaElement.querySelector('source').src : 
                        mediaElement.src;
                    
                    return {
                        id: mediaId,
                        url: url,
                        type: isVideo ? 'video/mp4' : 'image/jpeg'
                    };
                }
            }
            
            return null;
        }

        // Toggle message selection
        function toggleMessageSelection(msgId) {
            if (selectedMessages.has(msgId)) {
                selectedMessages.delete(msgId);
            } else {
                selectedMessages.add(msgId);
            }
            
            // Update display
            displayMessages();
            updateSelectedMessagesDisplay();
        }
        
        // Update selected messages display
        function updateSelectedMessagesDisplay() {
            if (selectedMessages.size === 0) {
                selectedMessagesContainer.innerHTML = '<p class="text-gray-500 italic">No messages selected. Select messages from the Chat Analysis tab.</p>';
                return;
            }
            
            selectedMessagesContainer.innerHTML = '';
            const selectedMsgs = chatMessages.filter(msg => selectedMessages.has(msg.id));
            
            selectedMsgs.forEach(msg => {
                const msgEl = document.createElement('div');
                msgEl.className = 'mb-2 pb-2 border-b border-justice-accent';
                msgEl.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-xs text-gray-400">${msg.formattedTimestamp}</span>
                        <span class="text-xs font-medium">${msg.sender}</span>
                    </div>
                    <p class="mt-1">${formatMessage(msg.message)}</p>
                `;
                selectedMessagesContainer.appendChild(msgEl);
            });
        }

        // Display statistics
        function displayStats() {
            // Basic stats
            const totalMessages = chatMessages.length;
            const messageWords = chatMessages.map(msg => msg.message.split(/\s+/).filter(w => w.length > 0).length);
            const totalWords = messageWords.reduce((sum, count) => sum + count, 0);
            
            // Calculate date range in days
            const firstDate = chatMessages.length > 0 ? chatMessages[0].timestamp : new Date();
            const lastDate = chatMessages.length > 0 ? chatMessages[chatMessages.length - 1].timestamp : new Date();
            const daysDiff = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // Count media messages
            const mediaCount = chatMessages.filter(msg => msg.isMedia).length;
            
            // Update stats UI
            totalMessagesEl.textContent = totalMessages.toLocaleString();
            totalWordsEl.textContent = totalWords.toLocaleString();
            activeDaysEl.textContent = `${daysDiff} days`;
            mediaCountEl.textContent = mediaCount.toLocaleString();
            
            // Sort participants by message count
            const sortedParticipants = [...participants.values()]
                .sort((a, b) => b.messageCount - a.messageCount);
            
            // Generate participants list
            participantsListEl.innerHTML = '';
            sortedParticipants.forEach(participant => {
                const participantEl = document.createElement('div');
                participantEl.className = 'flex justify-between items-center bg-justice p-2 rounded';
                participantEl.innerHTML = `
                    <div class="font-medium">${participant.name}</div>
                    <div class="text-gray-400">${participant.messageCount.toLocaleString()} msgs</div>
                `;
                participantsListEl.appendChild(participantEl);
            });
            
            // Update special message stats
            loveCountEl.textContent = `${loveExpressionsCount} instances found`;
            questionCountEl.textContent = `${questionsCount} questions found`;
            responseRateEl.textContent = `${questionResponseRate.toFixed(1)}% of questions received responses`;
            
            // Create word frequency chart
            createWordFrequencyChart();
        }

        // Create word frequency chart
        function createWordFrequencyChart() {
            // Get the top words
            const sortedWords = Object.entries(wordFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedWords.map(([word]) => word);
            const data = sortedWords.map(([, count]) => count);
            
            // Clear previous chart if exists
            if (wordChart) {
                wordChart.destroy();
            }
            
            // Get chart context
            const ctx = document.getElementById('word-freq-chart').getContext('2d');
            
            // Create chart
            wordChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: data,
                        backgroundColor: '#1a508b',
                        borderColor: '#0d2d4e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#d1d5db'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#d1d5db'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Filter and display messages
        function filterAndDisplayMessages() {
            const searchTerm = messageSearch.value.toLowerCase();
            const filterType = messageFilter.value;
            
            // Show reset button if filtering is active
            const resetBtn = document.getElementById('reset-filter');
            if (searchTerm || filterType !== 'all') {
                resetBtn.classList.remove('hidden');
            } else {
                resetBtn.classList.add('hidden');
            }
            
            filteredMessages = chatMessages.filter(msg => {
                // Apply search filter
                const matchesSearch = searchTerm === '' || 
                    msg.message.toLowerCase().includes(searchTerm) ||
                    msg.sender.toLowerCase().includes(searchTerm) ||
                    msg.id.toLowerCase().includes(searchTerm);
                
                // Apply type filter
                let matchesType = true;
                if (filterType === 'questions') {
                    matchesType = msg.isQuestion;
                } else if (filterType === 'phrases') {
                    matchesType = 
                        msg.message.toLowerCase().includes('i love you') ||
                        msg.message.toLowerCase().includes('miss you') ||
                        msg.message.toLowerCase().includes('thank you') ||
                        msg.message.toLowerCase().includes('sorry');
                } else if (filterType === 'media') {
                    matchesType = msg.isMedia;
                }
                
                return matchesSearch && matchesType;
            });
            
            // Reset to first page and display
            currentPage = 1;
            displayMessages();
        }
        
        // Reset all filters
        function resetAllFilters() {
            // Reset search
            messageSearch.value = '';
            
            // Reset filter type
            messageFilter.value = 'all';
            
            // Reset filtered messages to all messages
            filteredMessages = [...chatMessages];
            
            // Remove subject highlighting
            document.querySelectorAll('#participants-list > div').forEach(div => {
                div.classList.remove('bg-primary', 'bg-opacity-20');
            });
            
            // Reset message count text
            messageCountEl.textContent = `${filteredMessages.length} messages`;
            
            // Hide reset button
            document.getElementById('reset-filter').classList.add('hidden');
            
            // Reset to first page and display
            currentPage = 1;
            displayMessages();
        }

        // Format message for display
        function formatMessage(message) {
            let formattedMessage = message
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
            
            // Highlight emojis
            formattedMessage = formattedMessage.replace(
                /([\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}])/gu, 
                '<span class="text-lg">$1</span>'
            );
            
            return formattedMessage;
        }

        // Check if message is a question
        function isQuestionMessage(message) {
            // Remove URLs
            const messageWithoutUrls = message.replace(/https?:\/\/\S+/g, '');
            
            // Check for question marks
            if (messageWithoutUrls.includes('?')) {
                return true;
            }
            
            // Check for question words at start of sentences
            const questionStarters = [
                'who', 'what', 'when', 'where', 'why', 'how', 'is', 'are', 'was',
                'were', 'will', 'would', 'could', 'should', 'do', 'does', 'did',
                'have', 'has', 'had', 'can'
            ];
            
            const sentences = messageWithoutUrls.split(/[.!?]+/).filter(s => s.trim().length > 0);
            
            for (const sentence of sentences) {
                const firstWord = sentence.trim().split(/\s+/)[0].toLowerCase();
                if (questionStarters.includes(firstWord)) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Highlight evidence items
        function highlightEvidence(evidenceIds) {
            // Remove highlight from all evidence items
            document.querySelectorAll('.evidence-container').forEach(item => {
                item.classList.remove('ring-2', 'ring-primary', 'ring-offset-2', 'ring-offset-justice');
            });
            
            // Add highlight to selected evidence items
            evidenceIds.forEach(id => {
                const item = document.getElementById(`evidence-${id}`);
                if (item) {
                    item.classList.add('ring-2', 'ring-primary', 'ring-offset-2', 'ring-offset-justice');
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }

        // Query evidence using AI
        async function queryEvidence() {
            const query = evidenceQuery.value.trim();
            if (!query) return;
            
            // Show loading state
            queryResult.classList.remove('hidden');
            aiResponse.innerHTML = '<div class="flex justify-center py-4"><div class="loading-spinner"></div></div>';
            
            try {
                // Compile evidence for context
                const evidenceContext = Array.from(document.querySelectorAll('.evidence-container'))
                    .map(item => {
                        const id = item.id.replace('evidence-', '');
                        const timestamp = item.querySelector('.text-xs').textContent.replace('TIMESTAMP: ', '');
                        const content = item.querySelector('p').textContent;
                        return `[${id}] ${timestamp}: ${content}`;
                    })
                    .join('\n\n');
                
                // Create prompt for AI
                const prompt = `You are JUSTICE MINDS, an advanced evidence analysis system. Analyze the following WhatsApp chat evidence and answer this question:
                
                QUESTION: ${query}
                
                EVIDENCE:
                ${evidenceContext}
                
                Provide a concise, professional response that references specific evidence IDs when relevant. Format your response in a formal, authoritative style suitable for law enforcement or legal professionals.`;
                
                // Send to Claude-3.7-Sonnet for analysis
                if (!window.Poe) {
                    aiResponse.innerHTML = '<p class="text-red-500">Error: Poe API not available.</p>';
                    return;
                }
                
                // Register handler for AI response
                window.Poe.registerHandler("evidence-query-handler", (result) => {
                    const message = result.responses[0];
                    
                    if (message.status === "error") {
                        aiResponse.innerHTML = `<p class="text-red-500">Error: ${message.statusText || "Unknown error occurred"}</p>`;
                    } else if (message.status === "incomplete") {
                        // Update with streaming content
                        aiResponse.innerHTML = marked.parse(message.content);
                    } else if (message.status === "complete") {
                        // Final response
                        aiResponse.innerHTML = marked.parse(message.content);
                    }
                });
                
                // Send message to AI
                await window.Poe.sendUserMessage(
                    "@Claude-3.7-Sonnet " + prompt,
                    {
                        handler: "evidence-query-handler",
                        stream: true,
                        openChat: false
                    }
                );
                
            } catch (err) {
                aiResponse.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
            }
        }
        
        // Run AI analysis on selected messages
        async function runAnalysis() {
            if (selectedMessages.size === 0) {
                alert("Please select messages to analyze from the Chat Analysis tab.");
                return;
            }
            
            // Show loading state
            analysisLoading.style.display = 'flex';
            analysisLoading.classList.remove('hidden');
            analysisResults.innerHTML = '';
            
            try {
                // Get selected messages
                const selectedMsgs = chatMessages.filter(msg => selectedMessages.has(msg.id));
                
                // Get selected options
                const options = {
                    sentiment: document.getElementById('option-sentiment').checked,
                    entities: document.getElementById('option-entities').checked,
                    intent: document.getElementById('option-intent').checked,
                    timeline: document.getElementById('option-timeline').checked
                };
                
                // Get selected model
                const model = document.getElementById('ai-model-select').value;
                
                // Prepare messages for analysis
                const messagesForAnalysis = selectedMsgs
                    .map(msg => `[${msg.formattedTimestamp}] ${msg.sender}: ${msg.message}`)
                    .join('\n\n');
                
                // Create prompt for AI
                const prompt = `You are JUSTICE MINDS, an advanced digital evidence analysis system. Analyze the following WhatsApp chat messages:

CHAT MESSAGES:
${messagesForAnalysis}

REQUESTED ANALYSIS:
${options.sentiment ? '- Sentiment analysis of each message and overall conversation tone' : ''}
${options.entities ? '- Entity recognition (people, places, objects mentioned)' : ''}
${options.intent ? '- Intent detection and motivation analysis' : ''}
${options.timeline ? '- Timeline reconstruction and sequence of events' : ''}

Provide a detailed, professional analysis formatted in Markdown. Focus on factual observations and potential evidentiary value. Include headers, bullet points, and formatting for readability. Your analysis should be suitable for use in a law enforcement or legal context.`;

                // Register handler for AI response
                window.Poe.registerHandler("justice-minds-analysis", (result) => {
                    const message = result.responses[0];
                    
                    if (message.status === "error") {
                        analysisResults.innerHTML = `<p class="text-red-500">Error: ${message.statusText || "Unknown error occurred"}</p>`;
                        analysisLoading.classList.add('hidden');
                    } else if (message.status === "incomplete") {
                        // Update with streaming content
                        analysisResults.innerHTML = marked.parse(message.content);
                    } else if (message.status === "complete") {
                        // Final response
                        analysisResults.innerHTML = marked.parse(message.content);
                        analysisLoading.classList.add('hidden');
                    }
                });
                
                // Determine which bot to use based on model selection
                const botPrefix = model.split('/')[0] === 'anthropic' ? '@Claude-3.7-Sonnet' : 
                                  model.split('/')[0] === 'openai' ? '@o3-mini' : '@deepseek-r1-zero';
                
                // Send message to AI
                await window.Poe.sendUserMessage(
                    `${botPrefix} ${prompt}`,
                    {
                        handler: "justice-minds-analysis",
                        stream: true,
                        openChat: false
                    }
                );
                
            } catch (err) {
                analysisResults.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
                analysisLoading.classList.add('hidden');
            }
        }
        
        // Add new claim
        function addNewClaim() {
            // This is a placeholder function - in a real app, this would open a form or modal
            const claimsList = document.querySelector('.bg-justice-light .space-y-4');
            const newClaimEl = document.createElement('div');
            newClaimEl.className = 'bg-justice p-4 rounded-md';
            newClaimEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="font-medium">New Claim</h3>
                    <span class="badge badge-red">Draft</span>
                </div>
                <p class="mt-2 text-sm text-gray-300">Click to edit this claim and add supporting evidence.</p>
                <div class="mt-3 flex justify-between text-xs text-gray-400">
                    <span>REFERENCE: Pending</span>
                    <button class="text-primary hover:text-primary-light">Edit Claim</button>
                </div>
            `;
            claimsList.insertBefore(newClaimEl, document.getElementById('add-claim-btn'));
        }
        
        // Upload media files
        function uploadMedia() {
            const files = mediaInput.files;
            if (!files || files.length === 0) {
                alert("Please select media files to upload.");
                return;
            }
            
            const gallery = document.getElementById('media-gallery');
            
            // Process each file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) continue;
                
                const mediaId = `JM-M${(i + 3).toString().padStart(3, '0')}`;
                
                // Attempt to extract EXIF metadata (for images)
                let timestamp = '';
                if (file.type.startsWith('image/')) {
                    // In a real implementation, we would use EXIF.js or similar to extract metadata
                    // For demo, we'll use a timestamp close to chat messages
                    const demoTimestamps = [
                        "2020-10-19 18:15:22",
                        "2020-10-19 18:17:45",
                        "2020-10-19 19:05:12"
                    ];
                    timestamp = demoTimestamps[i % demoTimestamps.length];
                } else {
                    // For videos or when EXIF is not available
                    const now = new Date();
                    timestamp = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                }
                
                const mediaEl = document.createElement('div');
                mediaEl.className = 'bg-justice p-4 rounded-lg shadow-md';
                mediaEl.dataset.timestamp = timestamp; // Store timestamp for matching
                
                if (file.type.startsWith('image/')) {
                    // Create image preview
                    const imageUrl = URL.createObjectURL(file);
                    mediaEl.innerHTML = `
                        <div class="relative pb-[75%] bg-black rounded-md overflow-hidden mb-2">
                            <img src="${imageUrl}" alt="Uploaded evidence" class="absolute inset-0 w-full h-full object-cover">
                            <div class="absolute top-2 right-2 bg-justice-dark bg-opacity-75 px-2 py-1 rounded text-xs font-medium">
                                PHOTO
                            </div>
                        </div>
                        <div>
                            <h3 class="font-medium text-sm mb-1">EXHIBIT ${mediaId}</h3>
                            <p class="text-xs text-gray-400">Timestamp from metadata ‚Ä¢ ${timestamp}</p>
                            <div class="flex justify-between mt-2">
                                <button class="text-xs text-primary hover:text-primary-light">View Details</button>
                                <button class="text-xs text-primary hover:text-primary-light" onclick="addMediaToTimeline('${mediaId}', '${timestamp}', '${imageUrl}', 'image')">Add to Timeline</button>
                            </div>
                        </div>
                    `;
                } else if (file.type.startsWith('video/')) {
                    // Create video preview
                    const videoUrl = URL.createObjectURL(file);
                    mediaEl.innerHTML = `
                        <div class="relative pb-[75%] bg-black rounded-md overflow-hidden mb-2">
                            <video class="absolute inset-0 w-full h-full object-cover" controls>
                                <source src="${videoUrl}" type="${file.type}">
                                Your browser does not support the video tag.
                            </video>
                            <div class="absolute top-2 right-2 bg-justice-dark bg-opacity-75 px-2 py-1 rounded text-xs font-medium">
                                VIDEO
                            </div>
                        </div>
                        <div>
                            <h3 class="font-medium text-sm mb-1">EXHIBIT ${mediaId}</h3>
                            <p class="text-xs text-gray-400">Timestamp from metadata ‚Ä¢ ${timestamp}</p>
                            <div class="flex justify-between mt-2">
                                <button class="text-xs text-primary hover:text-primary-light">View Details</button>
                                <button class="text-xs text-primary hover:text-primary-light" onclick="addMediaToTimeline('${mediaId}', '${timestamp}', '${videoUrl}', 'video', '${file.type}')">Add to Timeline</button>
                            </div>
                        </div>
                    `;
                }
                
                gallery.appendChild(mediaEl);
            }
            
            // Clear input
            mediaInput.value = '';
            
            // Notify user
            alert("Media files uploaded. You can now toggle 'Show Media' in the Chat Analysis tab to view media inline, or click 'Add to Timeline' to integrate with the chat sequence.");
        }
        
        // Add media to chat timeline
        function addMediaToTimeline(mediaId, timestamp, url, type, mimeType = '') {
            // Create a new "virtual" message that represents the media
            const mediaMessage = {
                id: mediaId,
                sender: "SYSTEM",
                message: `<Media from ${mediaId}>`,
                timestamp: new Date(timestamp),
                formattedTimestamp: timestamp,
                isMedia: true,
                isQuestion: false,
                mediaDetails: {
                    id: mediaId,
                    url: url,
                    type: type,
                    mimeType: mimeType
                }
            };
            
            // Add to chat messages
            chatMessages.push(mediaMessage);
            
            // Sort messages by timestamp to integrate into timeline
            chatMessages.sort((a, b) => a.timestamp - b.timestamp);
            
            // Update filtered messages
            filteredMessages = [...chatMessages];
            
            // Reset to first page and refresh display
            currentPage = 1;
            displayMessages();
            
            // Notify user
            alert(`Media ${mediaId} has been added to the chat timeline.`);
        }
        
        // Handle timeline media uploads
        document.getElementById('timeline-media-input').addEventListener('change', function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            // Process each file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) continue;
                
                const mediaId = `JM-TM${(i + 1).toString().padStart(3, '0')}`;
                
                // For demo purposes, use predefined timestamps
                const demoTimestamps = [
                    "2020-10-19 18:15:22",
                    "2020-10-19 18:17:45",
                    "2020-10-19 19:05:12"
                ];
                const timestamp = demoTimestamps[i % demoTimestamps.length];
                
                // Create media URL
                const url = URL.createObjectURL(file);
                
                // Add directly to timeline
                addMediaToTimeline(
                    mediaId, 
                    timestamp, 
                    url, 
                    file.type.startsWith('image/') ? 'image' : 'video',
                    file.type
                );
            }
            
            // Clear input
            this.value = '';
        });
    </script>


</body></html>
